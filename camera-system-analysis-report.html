<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>动画编辑器摄像机系统分析报告</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 40px;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        h2 {
            color: #34495e;
            margin-top: 40px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
            padding-left: 15px;
        }
        h3 {
            color: #7f8c8d;
            margin-top: 25px;
            margin-bottom: 15px;
        }
        .section {
            margin-bottom: 40px;
        }
        .variable-group {
            margin-bottom: 30px;
        }
        .variable-card {
            background-color: #f9f9f9;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 3px solid #3498db;
        }
        .variable-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .variable-desc {
            color: #7f8c8d;
            font-size: 0.95em;
            margin-bottom: 3px;
        }
        .variable-default {
            font-family: 'Courier New', Courier, monospace;
            background-color: #ecf0f1;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #e74c3c;
        }
        .code-block {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 20px 0;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }
        .highlight {
            color: #3498db;
            font-weight: bold;
        }
        .optimization-card {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .optimization-title {
            font-weight: bold;
            color: #856404;
            margin-bottom: 10px;
        }
        .optimization-issue {
            color: #856404;
            margin-bottom: 8px;
        }
        .optimization-suggestion {
            color: #004085;
            background-color: #cce5ff;
            border-left: 4px solid #004085;
            padding: 10px;
            margin: 10px 0;
            border-radius: 0 4px 4px 0;
        }
        .flow-chart {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        .flow-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        .flow-number {
            background-color: #3498db;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            flex-shrink: 0;
            font-size: 0.8em;
            font-weight: bold;
        }
        .flow-text {
            flex-grow: 1;
        }
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            h1 {
                font-size: 1.8em;
            }
            h2 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>动画编辑器摄像机系统分析报告</h1>
        
        <div class="section">
            <h2>第一部分：摄像机系统初始化分析</h2>
            <p>摄像机系统的初始化位置在index.html的Vue组件setup函数中（大约1000-1150行）。以下是系统中所有关键变量的初始化分析：</p>
            
            <div class="variable-group">
                <h3>1. 基础控制变量</h3>
                <div class="variable-card">
                    <div class="variable-name">showCamera</div>
                    <div class="variable-desc">控制是否显示摄像机UI</div>
                    <div class="variable-default">默认值: false (ref类型)</div>
                </div>
                <div class="variable-card">
                    <div class="variable-name">showCameraPreview</div>
                    <div class="variable-desc">控制是否显示相机预览</div>
                    <div class="variable-default">默认值: false (ref类型)</div>
                </div>
                <div class="variable-card">
                    <div class="variable-name">showCameraTrack</div>
                    <div class="variable-desc">控制是否显示镜头轨道</div>
                    <div class="variable-default">默认值: true (ref类型)</div>
                </div>
                <div class="variable-card">
                    <div class="variable-name">enableCameraEdit</div>
                    <div class="variable-desc">控制是否启用摄像机编辑功能</div>
                    <div class="variable-default">默认值: false (ref类型)</div>
                </div>
            </div>
            
            <div class="variable-group">
                <h3>2. 摄像机尺寸和视口变量</h3>
                <div class="variable-card">
                    <div class="variable-name">cameraSizes</div>
                    <div class="variable-desc">预设的摄像机尺寸选项数组</div>
                    <div class="variable-default">默认值: 包含854×480、1280×720、1920×1080、2560×1440四种分辨率 (ref类型)</div>
                </div>
                <div class="variable-card">
                    <div class="variable-name">cameraWidth</div>
                    <div class="variable-desc">当前摄像机宽度</div>
                    <div class="variable-default">默认值: 1920 (cameraSizes.value[2].width) (普通变量)</div>
                </div>
                <div class="variable-card">
                    <div class="variable-name">cameraHeight</div>
                    <div class="variable-desc">当前摄像机高度</div>
                    <div class="variable-default">默认值: 1080 (cameraSizes.value[2].height) (普通变量)</div>
                </div>
                <div class="variable-card">
                    <div class="variable-name">selectedCameraSize</div>
                    <div class="variable-desc">当前选中的摄像机尺寸</div>
                    <div class="variable-default">默认值: cameraSizes.value[2] (1920×1080) (ref类型)</div>
                </div>
            </div>
            
            <div class="variable-group">
                <h3>3. 摄像机变换变量</h3>
                <div class="variable-card">
                    <div class="variable-name">cameraZoom</div>
                    <div class="variable-desc">摄像机缩放级别</div>
                    <div class="variable-default">默认值: 1 (ref类型)</div>
                </div>
                <div class="variable-card">
                    <div class="variable-name">cameraRotation</div>
                    <div class="variable-desc">摄像机旋转角度</div>
                    <div class="variable-default">默认值: 0度 (ref类型)</div>
                </div>
                <div class="variable-card">
                    <div class="variable-name">isMaintainingAspectRatio</div>
                    <div class="variable-desc">是否保持宽高比</div>
                    <div class="variable-default">默认值: true (ref类型)</div>
                </div>
                <div class="variable-card">
                    <div class="variable-name">useSmoothTransition</div>
                    <div class="variable-desc">是否使用平滑过渡</div>
                    <div class="variable-default">默认值: true (ref类型)</div>
                </div>
            </div>
            
            <div class="variable-group">
                <h3>4. 平滑过渡相关变量</h3>
                <div class="variable-card">
                    <div class="variable-name">isTransitioning</div>
                    <div class="variable-desc">是否正在进行平滑过渡</div>
                    <div class="variable-default">默认值: false (普通变量)</div>
                </div>
                <div class="variable-card">
                    <div class="variable-name">transitionDuration</div>
                    <div class="variable-desc">过渡持续时间</div>
                    <div class="variable-default">默认值: 500毫秒 (普通变量)</div>
                </div>
                <div class="variable-card">
                    <div class="variable-name">targetCameraX/Y/Zoom/Rotation</div>
                    <div class="variable-desc">目标摄像机变换参数</div>
                    <div class="variable-default">默认值: 0/0/1/0 (普通变量)</div>
                </div>
                <div class="variable-card">
                    <div class="variable-name">startCameraX/Y/Zoom/Rotation</div>
                    <div class="variable-desc">过渡开始时的摄像机变换参数</div>
                    <div class="variable-default">默认值: 0/0/1/0 (普通变量)</div>
                </div>
            </div>
            
            <div class="variable-group">
                <h3>5. 镜头预设相关变量</h3>
                <div class="variable-card">
                    <div class="variable-name">cameraPresets</div>
                    <div class="variable-desc">摄像机预设配置数组</div>
                    <div class="variable-default">默认值: 包含特写、近景、中景、全景四种预设 (ref类型)</div>
                </div>
                <div class="variable-card">
                    <div class="variable-name">defaultCameraScenery</div>
                    <div class="variable-desc">默认镜别设置</div>
                    <div class="variable-default">默认值: '全景' (ref类型)</div>
                </div>
                <div class="variable-card">
                    <div class="variable-name">defaultDialogCameraScenery</div>
                    <div class="variable-desc">默认对话镜别设置</div>
                    <div class="variable-default">默认值: '近景' (ref类型)</div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>第二部分：摄像机模块导入与初始化流程</h2>
            <div class="flow-chart">
                <div class="flow-step">
                    <div class="flow-number">1</div>
                    <div class="flow-text">通过ES模块动态导入camera.mjs</div>
                </div>
                <div class="flow-step">
                    <div class="flow-number">2</div>
                    <div class="flow-text">调用module.initCamera()方法初始化摄像机模块，传入必要的应用对象</div>
                </div>
                <div class="flow-step">
                    <div class="flow-number">3</div>
                    <div class="flow-text">获取摄像机模块导出的属性和方法引用</div>
                </div>
                <div class="flow-step">
                    <div class="flow-number">4</div>
                    <div class="flow-text">调用cameraModule.resetCamera()重置摄像机位置和尺寸</div>
                </div>
                <div class="flow-step">
                    <div class="flow-number">5</div>
                    <div class="flow-text">设置摄像机事件监听（setupCameraEvents）</div>
                </div>
            </div>
            
            <div class="code-block">
// 初始化摄像机模块
let cameraModule;

// 使用ES模块导入摄像机模块
import('./camera.mjs').then(module => {
  try {
    // 传入必要的应用对象给摄像机模块
    cameraModule = module.initCamera({
      showCameraPreview,
      previewCanvas,
      cameraSizes,
      cameraZoom,
      cameraRotation,
      isMaintainingAspectRatio,
      enableCameraRotation,
      showCameraInfo,
      useSmoothTransition,
      cameraPresets,
      defaultCameraScenery,
      canvas,
      ctx,
      offscreenCanvas,
      offscreenCtx,
      renderFrame,
      selectedCameraSize,
      timeline,
      expressionManager,
      getExpressionTrackByRoleId,
      calculateCurrentExpressPosition,
      enableCameraEdit
    });
    
    // 更新引用
    cameraWidth = cameraModule.cameraWidth;
    cameraHeight = cameraModule.cameraHeight;
    let size = {
      'width':cameraWidth,
      'height':cameraHeight
    }
    cameraModule.resetCamera(size);
    
    // 在摄像机模块初始化后设置setupCameraEvents
    setupCameraEvents = cameraModule.setupCameraEvents;
    
    // 确保设置摄像机事件监听
    if (canvas.value && setupCameraEvents && typeof setupCameraEvents === 'function') {
      setupCameraEvents();
    }
  } catch (error) {
    console.error('init camera module err:', error);
  }
});
            </div>
        </div>
        
        <div class="section">
            <h2>第三部分：localStorage数据持久化</h2>
            <p>该系统使用localStorage保存用户的默认镜头设置，确保用户在刷新页面或重新打开应用后能够恢复之前的设置。</p>
            
            <div class="variable-group">
                <h3>存储的设置</h3>
                <ul>
                    <li><strong>defaultCameraScenery</strong>: 默认镜别设置</li>
                    <li><strong>defaultDialogCameraScenery</strong>: 默认对话镜别设置</li>
                </ul>
            </div>
            
            <div class="variable-group">
                <h3>加载与更新机制</h3>
                <ul>
                    <li><strong>加载时机</strong>: 组件挂载后（onMounted生命周期钩子）</li>
                    <li><strong>更新机制</strong>: 当设置值改变时，自动同步到localStorage</li>
                    <li><strong>同步机制</strong>: 使用Vue.nextTick确保DOM更新后，同步更新select元素值并触发change事件</li>
                </ul>
            </div>
            
            <div class="code-block">
// 在组件挂载后
onMounted(() => {
  // 从localStorage加载保存的值
  // 加载默认镜头设置
  const savedValue = localStorage.getItem('defaultCameraScenery');
  if (savedValue) {
    defaultCameraScenery.value = savedValue;
  }
  
  // 加载默认对话镜头设置
  const savedDialogValue = localStorage.getItem('defaultDialogCameraScenery');
  if (savedDialogValue) {
    defaultDialogCameraScenery.value = savedDialogValue;
  }
  
  Vue.nextTick(() => {
    // 更新默认镜头select值
    const selectElement = document.querySelector('select[v-model="defaultCameraScenery"]');
    if (selectElement) {
      // 确保select值与defaultCameraScenery保持一致
      selectElement.value = defaultCameraScenery.value || '全景';
      // 触发change事件，确保Vue实例能够感知到这个变化
      const event = new Event('change', { bubbles: true });
      selectElement.dispatchEvent(event);
    }
    
    // 更新默认对话镜头select值
    const dialogSelectElement = document.querySelector('select[v-model="defaultDialogCameraScenery"]');
    if (dialogSelectElement) {
      // 确保select值与defaultDialogCameraScenery保持一致
      dialogSelectElement.value = defaultDialogCameraScenery.value || '近景';
      // 触发change事件，确保Vue实例能够感知到这个变化
      const dialogEvent = new Event('change', { bubbles: true });
      dialogSelectElement.dispatchEvent(dialogEvent);
    }
  });
});

// 当默认镜别改变时，将其存储到localStorage
watch(defaultCameraScenery, (newValue) => {
  localStorage.setItem('defaultCameraScenery', newValue);
});

// 当默认对话镜别改变时，将其存储到localStorage
watch(defaultDialogCameraScenery, (newValue) => {
  localStorage.setItem('defaultDialogCameraScenery', newValue);
});
            </div>
        </div>
        
        <div class="section">
            <h2>第四部分：摄像机更新逻辑分析</h2>
            <p>摄像机系统的核心更新逻辑位于<code>updateCameraOnPlayback</code>函数中（定义在camera.mjs文件中）。该函数负责在播放时根据当前时间和各种规则动态更新摄像机的位置和参数。</p>
            
            <h3>更新逻辑主要分为两大部分：</h3>
            <ol>
                <li><strong>判断逻辑</strong>: 确定目标景别和参数</li>
                <li><strong>执行逻辑</strong>: 根据判断结果更新摄像机位置和参数</li>
            </ol>
            
            <h3>判断逻辑中的主要规则：</h3>
            <ol>
                <li>开场默认镜头或场景切换时，使用默认景别</li>
                <li>有设置镜头轨道的镜头，使用指定的景别和参数</li>
                <li>无设置镜头轨道但当前有对话的情况，跟随说话人物</li>
                <li>无设置镜头轨道且当前无对话的情况，使用默认景别或保持当前状态</li>
            </ol>
            
            <h3>执行逻辑的主要步骤：</h3>
            <ol>
                <li>计算目标位置</li>
                <li>根据当前时间与镜头轨道开始时间对比，进行0.3秒内线性过渡</li>
                <li>确保镜头不超出画布范围</li>
            </ol>
        </div>
        
        <div class="section">
            <h2>第五部分：代码优化建议</h2>
            
            <div class="optimization-card">
                <div class="optimization-title">1. 变量初始化优化</div>
                <div class="optimization-issue"><strong>问题</strong>: 摄像机相关变量分散定义，缺乏组织性</div>
                <div class="optimization-suggestion"><strong>建议</strong>: 将摄像机相关变量统一组织在一个cameraConfig对象中，提高代码组织性和可维护性</div>
                <div class="code-block">
const cameraConfig = ref({
  show: false,
  preview: false,
  track: true,
  edit: false,
  width: cameraSizes.value[2].width,
  height: cameraSizes.value[2].height,
  zoom: 1,
  rotation: 0,
  // ...其他摄像机配置
});
                </div>
            </div>
            
            <div class="optimization-card">
                <div class="optimization-title">2. 错误处理优化</div>
                <div class="optimization-issue"><strong>问题</strong>: 摄像机模块加载失败的错误处理机制不够完善</div>
                <div class="optimization-suggestion"><strong>建议</strong>: 增强摄像机模块加载失败的错误处理机制，添加最大重试次数限制</div>
                <div class="code-block">
let importAttempts = 0;
const maxAttempts = 3;
const importCameraModule = () => {
  importAttempts++;
  import('./camera.mjs').then(module => {
    // 初始化代码...
  }).catch(error => {
    console.error(`加载摄像机模块失败 (尝试 ${importAttempts}/${maxAttempts})`, error);
    if (importAttempts < maxAttempts) {
      setTimeout(importCameraModule, 1000 * importAttempts); // 递增等待时间
    } else {
      console.error('达到最大重试次数，摄像机模块加载失败');
      // 提供降级方案...
    }
  });
};
                </div>
            </div>
            
            <div class="optimization-card">
                <div class="optimization-title">3. 类型定义优化</div>
                <div class="optimization-issue"><strong>问题</strong>: 缺乏明确的类型定义，不利于代码维护</div>
                <div class="optimization-suggestion"><strong>建议</strong>: 为摄像机相关数据结构添加TypeScript类型定义，提高代码健壮性</div>
                <div class="code-block">
// 在单独的types.js文件中定义
export interface CameraSize {
  name: string;
  width: number;
  height: number;
}
export interface CameraPreset extends CameraSize {
  rotation: number;
}
                </div>
            </div>
            
            <div class="optimization-card">
                <div class="optimization-title">4. 性能优化建议</div>
                <ul>
                    <li>在摄像机预览更新时使用防抖或节流技术，避免高频更新导致性能问题</li>
                    <li>考虑使用requestAnimationFrame来同步摄像机状态更新，与浏览器渲染周期保持一致</li>
                    <li>当不需要摄像机预览时，暂停相关的监听和更新逻辑，减少不必要的计算</li>
                </ul>
            </div>
            
            <div class="optimization-card">
                <div class="optimization-title">5. 架构优化建议</div>
                <ul>
                    <li>考虑将摄像机系统完全抽离为独立的类或模块，减少与主应用的耦合</li>
                    <li>使用事件驱动的方式处理摄像机状态变化，提高代码的可扩展性</li>
                    <li>添加单元测试，确保摄像机系统的稳定性和可靠性</li>
                </ul>
            </div>
        </div>
        
        <div class="section">
            <h2>总结</h2>
            <p>该项目的摄像机系统采用了模块化设计，结合Vue响应式系统和Canvas API实现了灵活的镜头控制功能。通过localStorage实现了用户偏好设置的持久化，并提供了丰富的摄像机变换选项和预设功能。</p>
            <p>系统核心由状态管理、模块导入、数据持久化和更新逻辑四大部分组成。摄像机更新逻辑根据不同的规则（如场景切换、对话状态等）动态调整摄像机的位置和参数，以提供最佳的视觉体验。</p>
            <p>通过实施上述优化建议，可以进一步提高代码的可维护性、健壮性和性能，使摄像机系统更加稳定和可靠。</p>
        </div>
    </div>
</body>
</html>